name: CI

on:
    push:
        branches: ["main"]
    pull_request:


jobs:
    build-test:
        runs-on: ubuntu-latest


        strategy:
            matrix:
                python-version: ["3.10", "3.11", "3.12"]

        
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4


            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: ${{ matrix.python-version }}

            
            - name: Install Poetry
              uses: abatilo/actions-poetry@v2
              with:
                poetry-version: "1.8.2"


            - name: Configure Poetry
              run: poetry config virtualenvs.in-project true


            - name: Cache Poetry dependencies
              uses: actions/cache@v4
              with:
                path: .venv
                key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}


            - name: Install dependencies (including dev tools)
              run: poetry install --with dev


            - name: Lint with Ruff
              run: poetry run ruff check .


            - name: Run tests with coverage
              run: poetry run pytest --cov=my_ci_cd_demo --cov-report=xml --cov-report=html

            - name: Upload coverage HTML
              uses: actions/upload-artifact@v4
              with:
                name: coverage-html
                path: htmlcov/

            - name: Upload coverage HTML
              uses: actions/upload-artifact@v4
              with:
                name: coverage-html-${{ matrix.python-version }}
                path: htmlcov/

            - name: Upload coverage XML
              uses: actions/upload-artifact@v4
              with:
                name: coverage-xml-${{ matrix.python-version }}
                path: coverage.xml


            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: demoapp-${{ matrix.python-version }}
                path: dist/demoapp